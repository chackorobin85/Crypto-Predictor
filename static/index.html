<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crypto Price Predictor</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0e1117;
      color: #ffffff;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      max-width: 600px;
      width: 100%;
      background-color: #1e222b;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }

    input, button, select {
      width: 100%;
      margin-top: 12px;
      padding: 14px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
    }

    input, select {
      background-color: #2b2f3a;
      color: #fff;
    }

    button {
      background-color: #4caf50;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }

    button:hover {
      background-color: #45a049;
    }

    canvas {
      margin-top: 25px;
      background-color: #ffffff;
      border-radius: 8px;
    }

    #result {
      margin-top: 20px;
      font-size: 16px;
      background-color: #2b2f3a;
      padding: 15px;
      border-radius: 8px;
    }

    #loader {
      display: none;
      text-align: center;
      margin-top: 10px;
    }

    @media (max-width: 600px) {
      .container {
        width: 90%;
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 style="text-align: center;">üîÆ Crypto Price Predictor</h2>

    <select id="symbolDropdown" onchange="syncSymbolInput()">
      <option value="BTC">Bitcoin (BTC)</option>
      <option value="ETH">Ethereum (ETH)</option>
      <option value="SOL">Solana (SOL)</option>
      <option value="ADA">Cardano (ADA)</option>
    </select>

    <input type="text" id="symbol" placeholder="e.g. bitcoin or BTC" />
    <input type="number" id="days" placeholder="Days ahead (e.g. 3)" />
    <button onclick="predict()">Predict</button>
    <button onclick="toggleTheme()">üåì Switch Theme</button>

    <div id="loader">üîÑ Predicting...</div>
    <div id="result"></div>
    <canvas id="priceChart" height="100"></canvas>
  </div>

  <script>
    let dark = true;
    let chart;
    let fullCoinList = [];

    function toggleTheme() {
      dark = !dark;
      document.body.style.backgroundColor = dark ? "#0e1117" : "#f0f0f0";
      document.body.style.color = dark ? "#ffffff" : "#000000";
    }

    function syncSymbolInput() {
      const dropdown = document.getElementById("symbolDropdown");
      document.getElementById("symbol").value = dropdown.value;
    }

    async function loadCoinList() {
      const res = await fetch("https://api.coingecko.com/api/v3/coins/list");
      fullCoinList = await res.json();
    }

    async function predict() {
      const loader = document.getElementById("loader");
      loader.style.display = "block";
      const resultBox = document.getElementById("result");
      resultBox.innerHTML = "";

      let symbolInput = document.getElementById("symbol").value.trim().toLowerCase();
      let match = fullCoinList.find(coin =>
        coin.symbol.toLowerCase() === symbolInput || coin.id.toLowerCase() === symbolInput
      );
      let coinId = match ? match.id : symbolInput;

      const daysAhead = parseInt(document.getElementById("days").value);

      try {
        const response = await fetch("https://crypto-predictor-02.onrender.com/predict_linear", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ symbol: coinId, days_ahead: daysAhead })
        });

        const data = await response.json();
        loader.style.display = "none";

        if (data.predicted_price_usd) {
          resultBox.innerHTML = `
            <strong>${data.symbol}</strong><br/>
            Days Ahead: ${data.days_ahead}<br/>
            Predicted Price: <strong>$${data.predicted_price_usd}</strong><br/>
            <em>${data.note}</em>
          `;

          // Chart
          let chartData;
          try {
            const chartRes = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=7`);
            chartData = await chartRes.json();

            if (!chartData.prices || chartData.prices.length === 0) {
              throw new Error("No chart data found");
            }
          } catch (err) {
            console.error("Chart fetch error:", err);
            resultBox.innerHTML += `<br><span style="color:red;">‚ö†Ô∏è Could not fetch price history for chart.</span>`;
            return;
          }

          const prices = chartData.prices.map(entry => entry[1]).slice(-30);
          const labels = Array.from({ length: prices.length }, (_, i) => `T-${prices.length - i}`);

          prices.push(data.predicted_price_usd);
          labels.push(`+${data.days_ahead}d`);

          if (chart) chart.destroy();

          chart = new Chart(document.getElementById("priceChart"), {
            type: "line",
            data: {
              labels: labels,
              datasets: [{
                label: `${match.symbol.toUpperCase()} Price`,
                data: prices,
                fill: false,
                borderColor: "#4caf50",
                backgroundColor: "#4caf50",
                tension: 0.2
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: true }
              },
              scales: {
                x: { ticks: { color: "#bbb" }},
                y: { ticks: { color: "#bbb" }}
              }
            }
          });

        } else {
          resultBox.innerHTML = `<span style="color:red;">Error: ${data.error}</span>`;
        }
      } catch (error) {
        loader.style.display = "none";
        resultBox.innerHTML = `<span style="color:red;">Something went wrong. Check your internet or server.</span>`;
      }
    }

    // Load coin list when the page loads
    window.onload = loadCoinList;
  </script>
</body>
</html>